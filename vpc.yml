SELECT
    sub.sales_total,
    sub.gross_profit_total,
    amt.sales_target,
    amt.gross_target AS gross_profit_target,
    /* YearMonthが今月の場合はprofit, そうでない場合は0 */
    CASE
        WHEN DATE_FORMAT(CURDATE(), '%Y-%m') = <<$YearMonth>> THEN
            profit_data.profit
        ELSE
            0
    END AS yesterday_gross_profit,
    /* YearMonthが今月の場合はprofit, そうでない場合は0 */
    CASE
        WHEN DATE_FORMAT(CURDATE(), '%Y-%m') = <<$YearMonth>> THEN
            /* 「昨日が月初の場合」と「最終日の場合」とそれ以外で分岐 */
            CASE
                WHEN DAY(DATE_SUB(CURDATE(), INTERVAL 1 DAY)) = 1 THEN
                    ROUND(profit_data.profit - (amt.gross_target / DAY(LAST_DAY(CURDATE()))))
                WHEN DATE_SUB(CURDATE(), INTERVAL 1 DAY) = LAST_DAY(CURDATE()) THEN
                    0
                ELSE
                    ROUND(profit_data.profit - ((amt.gross_target - day_before_yesterday_summary_data.day_before_yesterday_profit) / (DAY(LAST_DAY(CURDATE())) - DAY(CURDATE() - INTERVAL 2 DAY))))
            END
        ELSE
            0
    END AS yesterday_dynamic_gross_profit_target_diff_daily
FROM
    (SELECT
        SUM(conversion * advertiser_cost) AS sales_total,
        SUM(conversion * (advertiser_cost - media_reward)) AS gross_profit_total
    FROM
        (SELECT
            tag_daily_reports.date,
            conversion + IFNULL(tag_conversion_revisions.difference, 0) AS conversion,
            advertiser_cost,
            media_reward
        FROM
            tag_daily_reports
            INNER JOIN tags ON tags.id = tag_daily_reports.tag_id
            INNER JOIN creatives ON creatives.id = tags.creative_id
            INNER JOIN campaigns ON campaigns.id = tags.campaign_id
            LEFT JOIN tag_conversion_revisions ON
                tag_conversion_revisions.date = tag_daily_reports.date
                AND tag_conversion_revisions.tag_id = tag_daily_reports.tag_id
                AND tag_conversion_revisions.device = tag_daily_reports.device
        WHERE
            /* 下記で「Web案件はUA判定できないものを計上しない」を実現 */
            tag_daily_reports.date BETWEEN DATE_FORMAT(STR_TO_DATE(<<$YearMonth>>, '%Y-%m'), '%Y%m01') AND LAST_DAY(STR_TO_DATE(<<$YearMonth>>, '%Y-%m'))
            AND (creatives.type NOT LIKE '%Web%' OR tag_daily_reports.device != 'unknown')
        UNION ALL
        SELECT
            ntdr.date,
            ntdr.conversion,
            ntdr.advertiser_cost,
            ntdr.media_reward
        FROM
            no_tag_daily_reports_for_tag_conversion_revisions AS ntdr
            INNER JOIN tags ON tags.id = ntdr.tag_id
            INNER JOIN creatives ON creatives.id = tags.creative_id
            INNER JOIN campaigns ON campaigns.id = tags.campaign_id
        WHERE
            ntdr.date BETWEEN DATE_FORMAT(STR_TO_DATE(<<$YearMonth>>, '%Y-%m'), '%Y%m01') AND LAST_DAY(STR_TO_DATE(<<$YearMonth>>, '%Y-%m'))
    ) base
) sub
CROSS JOIN
    admin_monthly_targets amt
CROSS JOIN
    (SELECT SUM(conversion * (advertiser_cost - media_reward)) AS profit
    FROM (
        SELECT
            tag_daily_reports.date,
            conversion + IFNULL(tag_conversion_revisions.difference, 0) AS conversion,
            advertiser_cost,
            media_reward
        FROM
            tag_daily_reports
            INNER JOIN tags ON tags.id = tag_daily_reports.tag_id
            INNER JOIN creatives ON creatives.id = tags.creative_id
            INNER JOIN campaigns ON campaigns.id = tags.campaign_id
            LEFT JOIN tag_conversion_revisions ON
                tag_conversion_revisions.date = tag_daily_reports.date
                AND tag_conversion_revisions.tag_id = tag_daily_reports.tag_id
                AND tag_conversion_revisions.device = tag_daily_reports.device
        WHERE
            tag_daily_reports.date = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
            AND (creatives.type NOT LIKE '%Web%' OR tag_daily_reports.device != 'unknown')
        UNION ALL
        SELECT
            ntdr.date,
            ntdr.conversion,
            ntdr.advertiser_cost,
            ntdr.media_reward
        FROM
            no_tag_daily_reports_for_tag_conversion_revisions AS ntdr
            INNER JOIN tags ON tags.id = ntdr.tag_id
            INNER JOIN creatives ON creatives.id = tags.creative_id
            INNER JOIN campaigns ON campaigns.id = tags.campaign_id
        WHERE
            ntdr.date = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
    ) base
) profit_data
CROSS JOIN
    (SELECT SUM(conversion * (advertiser_cost - media_reward)) AS day_before_yesterday_profit
    FROM (
        SELECT
            tag_daily_reports.date,
            conversion + IFNULL(tag_conversion_revisions.difference, 0) AS conversion,
            advertiser_cost,
            media_reward
        FROM
            tag_daily_reports
            INNER JOIN tags ON tags.id = tag_daily_reports.tag_id
            INNER JOIN creatives ON creatives.id = tags.creative_id
            INNER JOIN campaigns ON campaigns.id = tags.campaign_id
            LEFT JOIN tag_conversion_revisions ON
                tag_conversion_revisions.date = tag_daily_reports.date
                AND tag_conversion_revisions.tag_id = tag_daily_reports.tag_id
                AND tag_conversion_revisions.device = tag_daily_reports.device
        WHERE
            tag_daily_reports.date BETWEEN DATE_FORMAT(CURDATE() ,'%Y-%m-01') AND DATE_SUB(CURDATE(), INTERVAL 2 DAY)
            AND (creatives.type NOT LIKE '%Web%' OR tag_daily_reports.device != 'unknown')
        UNION ALL
        SELECT
            ntdr.date,
            ntdr.conversion,
            ntdr.advertiser_cost,
            ntdr.media_reward
        FROM
            no_tag_daily_reports_for_tag_conversion_revisions AS ntdr
            INNER JOIN tags ON tags.id = ntdr.tag_id
            INNER JOIN creatives ON creatives.id = tags.creative_id
            INNER JOIN campaigns ON campaigns.id = tags.campaign_id
        WHERE
            ntdr.date BETWEEN DATE_FORMAT(CURDATE() ,'%Y-%m-01') AND DATE_SUB(CURDATE(), INTERVAL 2 DAY)
    ) base
) day_before_yesterday_summary_data
WHERE
    amt.year_month = <<$YearMonth>>